<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>2025 서울 주택사면 대상지</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=abf50f881fbafdf6787347059a09b69c&autoload=true&libraries=clusterer"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { width:100%; height:100%; }
    #controlPanel {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.95); padding:10px; border-radius: 10px;
    }
    #searchInput {
      padding: 8px; width: 220px; font-size: 15px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    #statsBox {
      position: absolute; bottom: 15px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.95); padding: 10px;
      border-radius: 10px; font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); max-height: 200px;
      overflow-y: auto; width: 260px;
    }
  </style>
</head>
<body>
  <div id="controlPanel">
    <input type="text" id="searchInput" placeholder="자치구 이름 (예: 은평구)" />
  </div>
  <div id="map"></div>
  <div id="statsBox"></div>

  <script>
    let map;
    const markerData = [
      { lat: 37.5163527777778, lng: 127.061530555556, title: "강남-건축-002/강남구/C", pdf: "pdf/강남-건축-002.pdf" },
      { lat: 37.4985777777778, lng: 127.03595, title: "강남-건축-003/강남구/C", pdf: "pdf/강남-건축-003.pdf" },
      { lat: 37.488175, lng: 127.036711111111, title: "강남-주택-001/강남구/C", pdf: "pdf/강남-주택-001.pdf" },
      // 다른 지점들 추가...
    ];

    function saveCompleted(title) {
      localStorage.setItem(`completed-${title}`, "true");
    }

    function isCompleted(title) {
      return localStorage.getItem(`completed-${title}`) === "true";
    }

    function countCompletedInDistrict(districtName) {
      return markerData.filter(item => {
        return item.title.includes(districtName) && isCompleted(item.title);
      }).length;
    }

    function renderMap(filteredData = markerData) {
      const mapContainer = document.getElementById("map");
      const mapOption = { center: new kakao.maps.LatLng(37.5665, 126.9780), level: 8 };
      map = new kakao.maps.Map(mapContainer, mapOption);

      filteredData.forEach((data) => {
        const position = new kakao.maps.LatLng(data.lat, data.lng);
        const iconUrl = isCompleted(data.title) ? "https://cdn-icons-png.flaticon.com/512/845/845646.png" : "https://cdn-icons-png.flaticon.com/512/545/545682.png";
        const markerImage = new kakao.maps.MarkerImage(iconUrl, new kakao.maps.Size(32, 32));
        const marker = new kakao.maps.Marker({
          map: map,
          position: position,
          image: markerImage
        });

        kakao.maps.event.addListener(marker, 'click', function() {
          saveCompleted(data.title);
          alert(`✅ 완료 처리: ${data.title}`);
          renderMap(filteredData); // 다시 렌더링해서 아이콘 업데이트
        });
      });
    }

    function updateStats(districtName) {
      const total = markerData.filter(m => m.title.includes(districtName)).length;
      const completed = countCompletedInDistrict(districtName);
      document.getElementById("statsBox").innerHTML =
        `<b>${districtName}</b><br>총 지점 수: ${total}<br>완료 지점 수: ${completed}`;
    }

    document.getElementById("searchInput").addEventListener("input", function() {
      const keyword = this.value.trim();
      if (keyword.length === 0) {
        renderMap(markerData);
        document.getElementById("statsBox").innerHTML = "";
        return;
      }
      const filtered = markerData.filter(item => item.title.includes(keyword));
      renderMap(filtered);
      updateStats(keyword);
    });

    renderMap();
  </script>
</body>
</html>
