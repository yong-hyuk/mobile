<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>서울 서부 지도</title>
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 90vh; }
    #controls {
      padding: 10px;
      background: #f0f0f0;
    }
  </style>
  <script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=abf50f881fbafdf6787347059a09b69c&libraries=clusterer"></script>
</head>
<body>

<div id="controls">
  <label>자치구 선택:
    <select id="districtSelect">
      <option value="">-- 전체 보기 --</option>
      <option value="은평구">은평구</option>
      <option value="마포구">마포구</option>
      <option value="서대문구">서대문구</option>
    </select>
    <button onclick="moveToMyLocation()">내 위치</button>
  </label>
</div>

<div id="map"></div>

<script>
const locations = [
  { lat: 37.6025, lng: 126.9291, title: "은평구/불광1동/1", pdf: "pdf/은평구.pdf" },
  { lat: 37.5794, lng: 126.8938, title: "마포구/망원1동/2", pdf: "pdf/마포구.pdf" },
  { lat: 37.5761, lng: 126.9357, title: "서대문구/충현동/3", pdf: "pdf/서대문구.pdf" },
  // 실제 데이터로 교체
];

const defaultIcon = new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35));
const completedIcon = new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png', new kakao.maps.Size(24, 35));

let map;
let markers = [];
let clusterer;
let myLocation = null;

function initMap() {
  map = new kakao.maps.Map(document.getElementById('map'), {
    center: new kakao.maps.LatLng(37.5665, 126.978),
    level: 6,
    mapTypeId: kakao.maps.MapTypeId.HYBRID
  });

  clusterer = new kakao.maps.MarkerClusterer({
    map: map,
    averageCenter: true,
    minLevel: 5
  });

  renderMarkers(locations);
}

function renderMarkers(locationList) {
  // 기존 제거
  markers.forEach(m => m.setMap(null));
  markers = [];
  clusterer.clear();

  locationList.forEach(loc => {
    const markerId = loc.title;
    const isCompleted = localStorage.getItem(markerId) === "true";

    const marker = new kakao.maps.Marker({
      map: map,
      position: new kakao.maps.LatLng(loc.lat, loc.lng),
      title: loc.title,
      image: isCompleted ? completedIcon : defaultIcon
    });

    marker.completed = isCompleted;

    // 마커 클릭 시 완료 토글
    kakao.maps.event.addListener(marker, 'click', function () {
      marker.completed = !marker.completed;
      localStorage.setItem(markerId, marker.completed);
      marker.setImage(marker.completed ? completedIcon : defaultIcon);
    });

    // 마커 인포 클릭 시 PDF 열기
    kakao.maps.event.addListener(marker, 'mouseover', function () {
      const iwContent = `<div style="padding:5px;font-size:13px;">${loc.title}<br/><a href="${loc.pdf}" target="_blank">[PDF]</a></div>`;
      const infowindow = new kakao.maps.InfoWindow({
        content: iwContent,
        removable: true
      });
      infowindow.open(map, marker);
    });

    markers.push(marker);
  });

  clusterer.addMarkers(markers);
}

function filterByDistrict(district) {
  if (!district) {
    renderMarkers(locations);
    return;
  }

  const filtered = locations.filter(loc => loc.title.includes(district));
  renderMarkers(filtered);
}

document.addEventListener('DOMContentLoaded', () => {
  initMap();

  document.getElementById('districtSelect').addEventListener('change', function () {
    const selected = this.value;
    filterByDistrict(selected);
  });
});

// 내 위치 이동
function moveToMyLocation() {
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (position) {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;
      myLocation = new kakao.maps.LatLng(lat, lng);

      const myMarker = new kakao.maps.Marker({
        map: map,
        position: myLocation,
        title: "내 위치"
      });

      map.setCenter(myLocation);
    });
  } else {
    alert("위치 서비스를 지원하지 않습니다.");
  }
}
</script>

</body>
</html>
