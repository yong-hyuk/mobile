<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>2025 서울 주택사면 대상지</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=abf50f881fbafdf6787347059a09b69c&autoload=true&libraries=clusterer"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; font-family:sans-serif; }
    #map { width:100%; height:100%; }
    #controlPanel {
      position: absolute; top: 10px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.95); padding:10px; border-radius: 10px;
    }
    #searchInput {
      padding: 8px; width: 220px; font-size: 15px;
      border: 1px solid #ccc; border-radius: 6px;
    }
    #statsBox {
      position: absolute; bottom: 15px; left: 10px; z-index: 10;
      background: rgba(255,255,255,0.95); padding: 10px;
      border-radius: 10px; font-size: 14px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); max-height: 260px;
      overflow-y: auto; width: 280px;
    }
    #locateBtn {
      position: absolute; bottom: 15px; right: 15px; z-index: 10;
      padding: 12px 18px; background-color: #007bff; color: white;
      border: none; border-radius: 12px; font-size: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3); cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="controlPanel">
    <input type="text" id="searchInput" placeholder="자치구 이름 (예: 은평구)" />
  </div>
  <div id="map"></div>
  <div id="statsBox"></div>
  <button id="locateBtn">실시간 위치 추적</button>

  <script>
    let map, userMarker;

    const defaultIconUrl = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png";
    const completedIconUrl = "https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/marker_red.png";

    const markerData = [
      { lat: 37.51635, lng: 127.06153, title: "강남-건축-002/강남구/C", pdf: "pdf/강남-건축-002.pdf" },
      { lat: 37.49857, lng: 127.03595, title: "강남-건축-003/강남구/C", pdf: "pdf/강남-건축-003.pdf" },
      { lat: 37.48817, lng: 127.03671, title: "강남-주택-001/강남구/C", pdf: "pdf/강남-주택-001.pdf" }
    ];

    function isCompleted(title) {
      return localStorage.getItem(`completed-${title}`) === "true";
    }

    function setCompleted(title, value) {
      localStorage.setItem(`completed-${title}`, value ? "true" : "false");
    }

    function extractDistrict(title) {
      const match = title.match(/\/([^\/]+구)/);
      return match ? match[1] : "기타";
    }

    function updateStats(district) {
      let total = 0;
      let completed = 0;
      markerData.forEach(data => {
        if (extractDistrict(data.title) === district) {
          total++;
          if (isCompleted(data.title)) completed++;
        }
      });

      const html =
        `<strong>${district} 완료 현황</strong><br>` +
        `총 지점: ${total}<br>` +
        `완료 지점: ${completed}`;
      document.getElementById("statsBox").innerHTML = html;
    }

    function renderMap(filteredData = markerData) {
      const center = new kakao.maps.LatLng(37.5665, 126.9780);
      const mapContainer = document.getElementById("map");
      map = new kakao.maps.Map(mapContainer, { center, level: 8 });
      map.setMapTypeId(kakao.maps.MapTypeId.HYBRID);

      filteredData.forEach(data => {
        const position = new kakao.maps.LatLng(data.lat, data.lng);
        const iconUrl = isCompleted(data.title) ? completedIconUrl : defaultIconUrl;
        const markerImage = new kakao.maps.MarkerImage(iconUrl, new kakao.maps.Size(32, 32));

        const marker = new kakao.maps.Marker({ position, map, image: markerImage });

        const infoHtml =
          `<div style="padding:5px;font-size:13px;">` +
          `<strong>${data.title}</strong><br/>` +
          `<label><input type="checkbox" ${isCompleted(data.title) ? "checked" : ""} onchange="toggleComplete('${data.title}')"/> 완료</label><br/>` +
          `<a href="${data.pdf}" target="_blank">[PDF 보기]</a></div>`;

        const infoWindow = new kakao.maps.InfoWindow({ content: infoHtml, removable: true });

        kakao.maps.event.addListener(marker, "click", () => {
          infoWindow.open(map, marker);
        });
      });
    }

    window.toggleComplete = function(title) {
      setCompleted(title, !isCompleted(title));
      const keyword = document.getElementById("searchInput").value.trim();
      const filtered = keyword ? markerData.filter(d => d.title.includes(keyword)) : markerData;
      renderMap(filtered);

      if (keyword) {
        const district = extractDistrict(filtered[0]?.title || "");
        updateStats(district);
      } else {
        document.getElementById("statsBox").innerHTML = "";
      }
    };

    document.getElementById("searchInput").addEventListener("input", function () {
      const keyword = this.value.trim();
      if (keyword === "") {
        renderMap();
        document.getElementById("statsBox").innerHTML = "";
      } else {
        const filtered = markerData.filter(d => d.title.includes(keyword));
        renderMap(filtered);

        const district = extractDistrict(filtered[0]?.title || "");
        updateStats(district);
      }
    });

    document.getElementById("locateBtn").addEventListener("click", () => {
      if (navigator.geolocation) {
        navigator.geolocation.watchPosition(pos => {
          const loc = new kakao.maps.LatLng(pos.coords.latitude, pos.coords.longitude);
          map.setCenter(loc);
          if (userMarker) userMarker.setMap(null);
          userMarker = new kakao.maps.Marker({ position: loc, map });
        }, err => {
          alert("위치 추적 실패: " + err.message);
        }, {
          enableHighAccuracy: true,
          maximumAge: 0,
          timeout: 10000
        });
      } else {
        alert("이 브라우저에서는 위치 찾기를 지원하지 않습니다.");
      }
    });

    renderMap();
  </script>
</body>
</html>
